# GitHub Global - æŠ€æœ¯å®ç°æ–¹æ¡ˆæ–‡æ¡£

**ç‰ˆæœ¬**: v1.2
**æ—¥æœŸ**: 2026-02-04
**é¡¹ç›®åç§°**: github-global
**ç®€åŒ–åŸåˆ™**: MVP æç®€å®ç°ï¼Œç§»é™¤æ‰€æœ‰éå¿…éœ€ç»„ä»¶

---

## ğŸ“‹ ç›®å½•

1. [æŠ€æœ¯æ ˆé€‰å‹](#1-æŠ€æœ¯æ ˆé€‰å‹)
2. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#2-ç³»ç»Ÿæ¶æ„è®¾è®¡)
3. [æ•°æ®åº“è®¾è®¡](#3-æ•°æ®åº“è®¾è®¡)
4. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#4-æ ¸å¿ƒæ¨¡å—è®¾è®¡)
5. [ä¸šåŠ¡æµç¨‹è®¾è®¡](#5-ä¸šåŠ¡æµç¨‹è®¾è®¡)
6. [API è®¾è®¡](#6-api-è®¾è®¡)
7. [å®‰å…¨è®¾è®¡](#7-å®‰å…¨è®¾è®¡)
8. [æŠ€æœ¯é£é™©ä¸åº”å¯¹](#8-æŠ€æœ¯é£é™©ä¸åº”å¯¹)
9. [å¼€å‘é‡Œç¨‹ç¢‘](#9-å¼€å‘é‡Œç¨‹ç¢‘)
10. [é™„å½•](#10-é™„å½•)

---

## 1. æŠ€æœ¯æ ˆé€‰å‹

### 1.1 å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|------|------|----------|
| **Next.js** | 15.x | ç°ä»£å…¨æ ˆæ¡†æ¶ï¼ŒApp Router æ”¯æŒ RSCï¼Œä¼˜ç§€çš„å¼€å‘ä½“éªŒ |
| **React** | 19.x | æœ€æ–°ç‰ˆæœ¬ï¼Œæ€§èƒ½ä¼˜åŒ–å®Œå–„ |
| **TypeScript** | 5.x | ç±»å‹å®‰å…¨ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯ |
| **TailwindCSS** | 3.x | å¿«é€Ÿ UI å¼€å‘ï¼Œå“åº”å¼è®¾è®¡ |
| **shadcn/ui** | latest | é«˜è´¨é‡ç»„ä»¶åº“ï¼ŒåŸºäº Radix UI |
| **Zustand** | latest | è½»é‡çº§çŠ¶æ€ç®¡ç†ï¼Œæ›¿ä»£ Redux |

### 1.2 åç«¯æŠ€æœ¯æ ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

| æŠ€æœ¯ | ç‰ˆæœ¬ | é€‰å‹ç†ç”± |
|------|------|----------|
| **Node.js** | 20.x LTS | é•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼Œç¨³å®šå¯é  |
| **Next.js API Routes** | 15.x | ä¸å‰ç«¯ä¸€ä½“åŒ–ï¼Œæ”¯æŒ Server Actions |
| **Prisma** | 5.x | ç±»å‹å®‰å…¨çš„ ORMï¼Œå¼€å‘ä½“éªŒä¼˜ç§€ |
| **p-queue** | 8.x | è½»é‡çº§æœ¬åœ°é˜Ÿåˆ—ï¼Œçº¯ JS å®ç° |

### 1.3 æ•°æ®å­˜å‚¨ï¼ˆç®€åŒ–ç‰ˆï¼‰

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **MySQL** | 8.0+ | ä¸»æ•°æ®åº“ï¼ˆæœ¬åœ°å®ä¾‹ï¼‰ |

**å·²ç§»é™¤**ï¼šâŒ Redisï¼ˆæš‚ä¸éœ€è¦ï¼‰

### 1.4 ç¬¬ä¸‰æ–¹é›†æˆ

| åº“/æœåŠ¡ | ç”¨é€” |
|---------|------|
| **Octokit** | GitHub REST API å®¢æˆ·ç«¯ |
| **@octokit/webhooks** | GitHub Webhook éªŒè¯å’Œå¤„ç† |
| **NextAuth.js** | GitHub OAuth è®¤è¯ï¼ˆèº«ä»½è¯†åˆ«ï¼‰ |
| **OpenRouter** | ç»Ÿä¸€ LLM API ç½‘å…³ï¼ˆç¿»è¯‘å¼•æ“ï¼‰ |
| **OpenAI SDK** | OpenRouter å…¼å®¹å±‚ |
| **unified/remark** | Markdown è§£æå’Œå¤„ç† |

### 1.5 æ ¸å¿ƒå†³ç­–

#### âœ… GitHub App vs OAuth App

**é€‰æ‹©ï¼šGitHub App + OAuth æ··åˆæ¨¡å¼**

| åŠŸèƒ½ | æ–¹æ¡ˆ | ç†ç”± |
|------|------|------|
| **ç”¨æˆ·ç™»å½•** | GitHub OAuth | ä»…ç”¨äºèº«ä»½è¯†åˆ«ï¼Œè·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ |
| **ä»“åº“æ“ä½œ** | GitHub App | ç»†ç²’åº¦æƒé™ã€æ›´é«˜ API é™æµã€ç‹¬ç«‹ Bot æ¨¡å¼ |

**GitHub App æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… **ç»†ç²’åº¦æƒé™**ï¼šç²¾ç¡®åˆ°ä»“åº“çº§åˆ«
- âœ… **æ›´é«˜é™æµ**ï¼šæ¯ä»“åº“ 5000 æ¬¡/å°æ—¶
- âœ… **Bot æ¨¡å¼**ï¼šç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–ç”¨æˆ·
- âœ… **çŸ­æœŸ Token**ï¼š1 å°æ—¶è‡ªåŠ¨åˆ·æ–°ï¼Œæ›´å®‰å…¨
- âœ… **ç»„ç»‡æ”¯æŒ**ï¼šå®Œç¾æ”¯æŒç»„ç»‡å®‰è£…

#### âœ… ç¿»è¯‘å¼•æ“æ¶æ„

**é€‰æ‹©ï¼šOpenRouter ç»Ÿä¸€ç½‘å…³**

**OpenRouter æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… **ç»Ÿä¸€æ¥å£**ï¼šä¸€ä¸ª API æ¥å…¥ 100+ æ¨¡å‹
- âœ… **å®Œå…¨å…¼å®¹**ï¼šæ”¯æŒ OpenAI SDKï¼Œé›¶å­¦ä¹ æˆæœ¬
- âœ… **æ¨¡å‹åˆ‡æ¢**ï¼šæ”¹é…ç½®å³å¯ï¼Œæ— éœ€æ”¹ä»£ç 
- âœ… **è‡ªåŠ¨é™çº§**ï¼šå†…ç½® fallback æœºåˆ¶
- âœ… **æˆæœ¬ä¼˜åŒ–**ï¼šè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ä»·æ ¼

**æ”¯æŒçš„æ¨¡å‹**ï¼š
```typescript
// å¯ä»¥è½»æ¾åˆ‡æ¢çš„æ¨¡å‹åˆ—è¡¨
const MODELS = {
  openai: [
    'openai/gpt-4-turbo',
    'openai/gpt-4o',
    'openai/gpt-4o-mini'
  ],
  anthropic: [
    'anthropic/claude-3-opus',
    'anthropic/claude-3.5-sonnet'
  ],
  google: [
    'google/gemini-pro-1.5'
  ],
  deepseek: [
    'deepseek/deepseek-chat'
  ]
  // ... 100+ å…¶ä»–æ¨¡å‹
}
```

#### âœ… é˜Ÿåˆ—æ–¹æ¡ˆï¼ˆç®€åŒ–ç‰ˆï¼‰

**é€‰æ‹©ï¼šp-queueï¼ˆæœ¬åœ°é˜Ÿåˆ—ï¼‰**

| ç‰¹æ€§ | BullMQ + Redis | p-queueï¼ˆæœ¬åœ°ï¼‰ |
|------|----------------|----------------|
| **å¤–éƒ¨ä¾èµ–** | âŒ éœ€è¦ Redis | âœ… æ— å¤–éƒ¨ä¾èµ– |
| **æŒä¹…åŒ–** | âœ… ä»»åŠ¡æŒä¹…åŒ– | âŒ é‡å¯ä¸¢å¤± |
| **åˆ†å¸ƒå¼** | âœ… æ”¯æŒå¤šæœº | âŒ å•æœº |
| **å¤æ‚åº¦** | ğŸ”´ é«˜ | ğŸŸ¢ ä½ |
| **é€‚ç”¨åœºæ™¯** | ç”Ÿäº§ç¯å¢ƒ | MVP å¼€å‘ |

**MVP é˜¶æ®µä¸ºä»€ä¹ˆé€‰æ‹© p-queueï¼Ÿ**
- âœ… é›¶å¤–éƒ¨ä¾èµ–ï¼Œä¸éœ€è¦å®‰è£… Redis
- âœ… ç®€å•æ˜“ç”¨ï¼ŒAPI æ¸…æ™°
- âœ… æ”¯æŒå¹¶å‘æ§åˆ¶
- âœ… æ»¡è¶³ MVP éœ€æ±‚

**åç»­å¦‚ä½•æ‰©å±•åˆ° BullMQï¼Ÿ**
```typescript
// å°è£…é˜Ÿåˆ—æ¥å£ï¼Œæ–¹ä¾¿åç»­æ›¿æ¢
interface ITranslationQueue {
  add(task: TranslationTask): Promise<void>
  process(handler: (task) => Promise<void>): void
}

// MVP é˜¶æ®µå®ç°
class LocalQueue implements ITranslationQueue {
  private queue = new PQueue({ concurrency: 5 })
  // ...
}

// ç”Ÿäº§ç¯å¢ƒå®ç°ï¼ˆåç»­ï¼‰
class BullMQQueue implements ITranslationQueue {
  private queue: Queue
  // ...
}
```

---

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„å›¾ï¼ˆç®€åŒ–ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                                â”‚
â”‚                    (Next.js Frontend)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTPS
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Next.js åº”ç”¨å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routes  â”‚  â”‚ Web Actions  â”‚  â”‚  æœ¬åœ°é˜Ÿåˆ— (p-queue) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    MySQL      â”‚                       â”‚ OpenRouter  â”‚
â”‚   (Prisma)    â”‚                       â”‚  (ç¿»è¯‘API)   â”‚
â”‚   (æœ¬åœ°å®ä¾‹)   â”‚                       â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub App    â”‚                       â”‚ GitHub API  â”‚
â”‚ (Bot Token)   â”‚                       â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç®€åŒ–è¯´æ˜**ï¼š
- âŒ ç§»é™¤äº† Redis
- âŒ ç§»é™¤äº†ç‹¬ç«‹çš„ Worker è¿›ç¨‹
- âœ… ä½¿ç”¨ Next.js API Route å†…çš„æœ¬åœ°é˜Ÿåˆ—
- âœ… ç¿»è¯‘ä»»åŠ¡åœ¨ API Route ä¸­å¼‚æ­¥å¤„ç†

### 2.2 è®¤è¯ä¸æˆæƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·è®¿é—®æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è®¿é—®
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GitHub OAuth  â”‚  â† ä»…ç”¨äºèº«ä»½è¯†åˆ«ï¼ˆç™»å½•ï¼‰
â”‚   (ç™»å½•)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Session å»ºç«‹  â”‚
â”‚ (JWT Token)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·å®‰è£…      â”‚  â† ç”¨äºä»“åº“æ“ä½œæƒé™
â”‚ GitHub App    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿæˆ Bot Tokenâ”‚  â† ç”¨äº API è°ƒç”¨
â”‚ (çŸ­æœŸã€è‡ªåŠ¨   â”‚
â”‚  åˆ·æ–°)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ¨¡å—åˆ’åˆ†

```
github-global/
â”œâ”€â”€ app/                      # Next.js App Router
â”‚   â”œâ”€â”€ (auth)/              # è®¤è¯ç›¸å…³é¡µé¢
â”‚   â”‚   â”œâ”€â”€ login/           # ç™»å½•é¡µ
â”‚   â”‚   â””â”€â”€ install/         # GitHub App å®‰è£…å¼•å¯¼
â”‚   â”œâ”€â”€ (dashboard)/         # ä»ªè¡¨æ¿é¡µé¢
â”‚   â”‚   â”œâ”€â”€ repositories/    # ä»“åº“ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ translations/    # ç¿»è¯‘ä»»åŠ¡
â”‚   â”‚   â””â”€â”€ settings/        # è®¾ç½®
â”‚   â”œâ”€â”€ api/                 # API Routes
â”‚   â”‚   â”œâ”€â”€ auth/           # è®¤è¯ API
â”‚   â”‚   â”œâ”€â”€ repositories/   # ä»“åº“ç®¡ç† API
â”‚   â”‚   â”œâ”€â”€ translations/   # ç¿»è¯‘ API
â”‚   â”‚   â””â”€â”€ webhooks/       # Webhook æ¥æ”¶
â”‚   â””â”€â”€ layout.tsx
â”‚
â”œâ”€â”€ lib/                     # æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ auth/               # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ github-oauth.ts # GitHub OAuth
â”‚   â”‚   â””â”€â”€ session.ts      # Session ç®¡ç†
â”‚   â”œâ”€â”€ github/             # GitHub API å°è£…
â”‚   â”‚   â”œâ”€â”€ app.ts          # GitHub App ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ client.ts       # API å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ webhook.ts      # Webhook å¤„ç†
â”‚   â”œâ”€â”€ translation/        # ç¿»è¯‘å¼•æ“
â”‚   â”‚   â”œâ”€â”€ openrouter.ts   # OpenRouter å¼•æ“
â”‚   â”‚   â””â”€â”€ markdown.ts     # Markdown å¤„ç†
â”‚   â”œâ”€â”€ queue/              # æœ¬åœ°é˜Ÿåˆ— âœ…
â”‚   â”‚   â””â”€â”€ translation-queue.ts
â”‚   â””â”€â”€ crypto/             # åŠ å¯†å·¥å…·
â”‚
â””â”€â”€ prisma/                  # æ•°æ®åº“ Schema
    â””â”€â”€ schema.prisma
```

---

## 3. æ•°æ®åº“è®¾è®¡

### 3.1 æ•°æ®è¡¨è®¾è®¡

#### 3.1.1 Userï¼ˆç”¨æˆ·è¡¨ï¼‰

```sql
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    github_id VARCHAR(64) UNIQUE NOT NULL,
    username VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    avatar_url TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_github_id (github_id),
    INDEX idx_username (username)
);
```

#### 3.1.2 GitHubAppInstallationï¼ˆGitHub App å®‰è£…è®°å½•è¡¨ï¼‰

```sql
CREATE TABLE github_app_installations (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    installation_id BIGINT NOT NULL,
    github_account_id BIGINT NOT NULL,
    account_login VARCHAR(255) NOT NULL,
    account_type ENUM('user', 'organization') NOT NULL,
    permissions JSON NOT NULL,
    repository_selection ENUM('all', 'selected') NOT NULL,
    access_token TEXT,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_installation_id (installation_id),
    UNIQUE KEY unique_installation (installation_id)
);
```

#### 3.1.3 Repositoryï¼ˆä»“åº“è¡¨ï¼‰

```sql
CREATE TABLE repositories (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    installation_id VARCHAR(36) NOT NULL,
    github_repo_id BIGINT UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    description TEXT,
    language VARCHAR(100),
    stargazers_count INT DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    webhook_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (installation_id) REFERENCES github_app_installations(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_github_repo_id (github_repo_id),
    INDEX idx_installation_id (installation_id)
);
```

#### 3.1.4 TranslationConfigï¼ˆç¿»è¯‘é…ç½®è¡¨ï¼‰

```sql
CREATE TABLE translation_configs (
    id VARCHAR(36) PRIMARY KEY,
    repository_id VARCHAR(36) UNIQUE NOT NULL,
    base_language VARCHAR(10) DEFAULT 'auto',
    target_languages JSON NOT NULL, -- ["en", "ja", "es"]
    file_patterns JSON NOT NULL,    -- ["**/*.md", "**/*.txt"]
    exclude_patterns JSON,          -- ["!**/node_modules/**"]
    target_branch_template VARCHAR(255) DEFAULT 'i18n/{lang}',
    commit_message_template VARCHAR(500) DEFAULT 'docs: translate to {lang}',
    sync_strategy ENUM('full', 'incremental', 'manual') DEFAULT 'full',
    trigger_mode ENUM('webhook', 'cron', 'manual') DEFAULT 'webhook',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE,
    INDEX idx_repository_id (repository_id)
);
```

#### 3.1.5 TranslationEngineï¼ˆç¿»è¯‘å¼•æ“é…ç½®è¡¨ï¼‰

```sql
CREATE TABLE translation_engines (
    id VARCHAR(36) PRIMARY KEY,
    repository_id VARCHAR(36) NOT NULL,
    engine_type ENUM('openrouter', 'openai', 'deepl', 'google', 'claude', 'azure') NOT NULL,
    encrypted_api_key TEXT NOT NULL,
    config JSON NOT NULL, -- å­˜å‚¨å¼•æ“ç‰¹å®šé…ç½®
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE,
    INDEX idx_repository_id (repository_id),
    INDEX idx_engine_type (engine_type)
);
```

#### 3.1.6 TranslationTaskï¼ˆç¿»è¯‘ä»»åŠ¡è¡¨ï¼‰

```sql
CREATE TABLE translation_tasks (
    id VARCHAR(36) PRIMARY KEY,
    repository_id VARCHAR(36) NOT NULL,
    trigger_type ENUM('webhook', 'manual', 'cron') NOT NULL,
    trigger_commit_sha VARCHAR(40),
    status ENUM('pending', 'processing', 'completed', 'failed', 'cancelled') DEFAULT 'pending',
    total_files INT DEFAULT 0,
    processed_files INT DEFAULT 0,
    failed_files INT DEFAULT 0,
    total_tokens INT DEFAULT 0,
    estimated_cost DECIMAL(10, 4),
    error_message TEXT,
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE,
    INDEX idx_repository_id (repository_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

#### 3.1.7 TranslationFileï¼ˆæ–‡ä»¶ç¿»è¯‘è®°å½•è¡¨ï¼‰

```sql
CREATE TABLE translation_files (
    id VARCHAR(36) PRIMARY KEY,
    task_id VARCHAR(36) NOT NULL,
    repository_id VARCHAR(36) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    target_language VARCHAR(10) NOT NULL,
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    source_content_hash VARCHAR(64), -- SHA256
    translated_content_hash VARCHAR(64),
    tokens_used INT DEFAULT 0,
    error_message TEXT,
    pr_number INT, -- å…³è”çš„ PR ç¼–å·
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES translation_tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE,
    INDEX idx_task_id (task_id),
    INDEX idx_repository_id (repository_id),
    INDEX idx_file_path (file_path(255)),
    INDEX idx_status (status)
);
```

#### 3.1.8 TranslationHistoryï¼ˆç¿»è¯‘å†å²è¡¨ï¼‰

```sql
CREATE TABLE translation_history (
    id VARCHAR(36) PRIMARY KEY,
    task_id VARCHAR(36) NOT NULL,
    repository_id VARCHAR(36) NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    event_data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (task_id) REFERENCES translation_tasks(id) ON DELETE CASCADE,
    FOREIGN KEY (repository_id) REFERENCES repositories(id) ON DELETE CASCADE,
    INDEX idx_task_id (task_id),
    INDEX idx_repository_id (repository_id),
    INDEX idx_created_at (created_at)
);
```

#### 3.1.9 WebhookEventï¼ˆWebhook äº‹ä»¶æ—¥å¿—è¡¨ï¼‰

```sql
CREATE TABLE webhook_events (
    id VARCHAR(36) PRIMARY KEY,
    repository_id VARCHAR(36),
    github_delivery_id VARCHAR(64) UNIQUE NOT NULL,
    event_type VARCHAR(50) NOT NULL,
    payload JSON NOT NULL,
    processed BOOLEAN DEFAULT false,
    error_message TEXT,
    received_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    processed_at TIMESTAMP NULL,
    INDEX idx_repository_id (repository_id),
    INDEX idx_github_delivery_id (github_delivery_id),
    INDEX idx_processed (processed)
);
```

### 3.2 Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                String   @id @default(uuid())
  githubId          String   @unique @map("github_id")
  username          String
  email             String?
  avatarUrl         String?  @map("avatar_url")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  installations     GitHubAppInstallation[]
  repositories      Repository[]

  @@map("users")
}

model GitHubAppInstallation {
  id                   String   @id @default(uuid())
  userId               String   @map("user_id")
  installationId       BigInt   @map("installation_id")
  githubAccountId      BigInt   @map("github_account_id")
  accountLogin         String   @map("account_login")
  accountType          String   @map("account_type")
  permissions          Json
  repositorySelection  String   @map("repository_selection")
  accessToken          String?  @map("access_token") @db.Text
  expiresAt            DateTime? @map("expires_at")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  repositories         Repository[]

  @@unique([installationId])
  @@index([userId])
  @@index([installationId])
  @@map("github_app_installations")
}

model Repository {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  installationId   String   @map("installation_id")
  githubRepoId     BigInt   @map("github_repo_id")
  name             String
  fullName         String   @map("full_name")
  description      String?  @db.Text
  language         String?
  stargazersCount  Int      @default(0) @map("stargazers_count")
  isActive         Boolean  @default(true) @map("is_active")
  webhookId        String?  @map("webhook_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  installation     GitHubAppInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  config           TranslationConfig?
  engines          TranslationEngine[]
  tasks            TranslationTask[]
  files            TranslationFile[]

  @@index([userId])
  @@index([githubRepoId])
  @@index([installationId])
  @@map("repositories")
}

model TranslationConfig {
  id                       String   @id @default(uuid())
  repositoryId             String   @unique @map("repository_id")
  baseLanguage             String   @default("auto") @map("base_language")
  targetLanguages          Json     @map("target_languages")
  filePatterns             Json     @map("file_patterns")
  excludePatterns          Json?    @map("exclude_patterns")
  targetBranchTemplate     String   @default("i18n/{lang}") @map("target_branch_template")
  commitMessageTemplate    String   @default("docs: translate to {lang}") @map("commit_message_template")
  syncStrategy             String   @default("full") @map("sync_strategy")
  triggerMode              String   @default("webhook") @map("trigger_mode")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")

  repository               Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([repositoryId])
  @@map("translation_configs")
}

model TranslationEngine {
  id              String   @id @default(uuid())
  repositoryId    String   @map("repository_id")
  engineType      String   @map("engine_type")
  encryptedApiKey String   @map("encrypted_api_key") @db.Text
  config          Json
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  repository      Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([repositoryId])
  @@index([engineType])
  @@map("translation_engines")
}

model TranslationTask {
  id                String                @id @default(uuid())
  repositoryId      String                @map("repository_id")
  triggerType       String                @map("trigger_type")
  triggerCommitSha  String?               @map("trigger_commit_sha")
  status            String                @default("pending")
  totalFiles        Int                   @default(0) @map("total_files")
  processedFiles    Int                   @default(0) @map("processed_files")
  failedFiles       Int                   @default(0) @map("failed_files")
  totalTokens       Int                   @default(0) @map("total_tokens")
  estimatedCost     Decimal?              @map("estimated_cost") @db.Decimal(10, 4)
  errorMessage      String?               @map("error_message") @db.Text
  startedAt         DateTime?             @map("started_at")
  completedAt       DateTime?             @map("completed_at")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  repository        Repository            @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  files             TranslationFile[]
  history           TranslationHistory[]

  @@index([repositoryId])
  @@index([status])
  @@index([createdAt])
  @@map("translation_tasks")
}

model TranslationFile {
  id                    String    @id @default(uuid())
  taskId                String    @map("task_id")
  repositoryId          String    @map("repository_id")
  filePath              String    @map("file_path") @db.VarChar(500)
  targetLanguage        String    @map("target_language")
  status                String    @default("pending")
  sourceContentHash     String?   @map("source_content_hash")
  translatedContentHash String?   @map("translated_content_hash")
  tokensUsed            Int       @default(0) @map("tokens_used")
  errorMessage          String?   @map("error_message") @db.Text
  prNumber              Int?      @map("pr_number")
  startedAt             DateTime? @map("started_at")
  completedAt           DateTime? @map("completed_at")
  createdAt             DateTime  @default(now()) @map("created_at")

  task                  TranslationTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  repository            Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([repositoryId])
  @@index([filePath])
  @@index([status])
  @@map("translation_files")
}

model TranslationHistory {
  id            String   @id @default(uuid())
  taskId        String   @map("task_id")
  repositoryId  String   @map("repository_id")
  eventType     String   @map("event_type")
  eventData     Json     @map("event_data")
  createdAt     DateTime @default(now()) @map("created_at")

  task          TranslationTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  repository    Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([repositoryId])
  @@index([createdAt])
  @@map("translation_history")
}

model WebhookEvent {
  id               String    @id @default(uuid())
  repositoryId     String?   @map("repository_id")
  githubDeliveryId String    @unique @map("github_delivery_id")
  eventType        String    @map("event_type")
  payload          Json
  processed        Boolean   @default(false)
  errorMessage     String?   @map("error_message") @db.Text
  receivedAt       DateTime  @default(now()) @map("received_at")
  processedAt      DateTime? @map("processed_at")

  @@index([repositoryId])
  @@index([githubDeliveryId])
  @@index([processed])
  @@map("webhook_events")
}
```

---

## 4. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 4.1 æœ¬åœ°é˜Ÿåˆ—æ¨¡å—ï¼ˆç®€åŒ–ç‰ˆï¼‰âœ…

```typescript
// lib/queue/translation-queue.ts
import PQueue from 'p-queue'

export class TranslationQueue {
  private queue: PQueue
  private static instance: TranslationQueue

  private constructor() {
    // é…ç½®å¹¶å‘é˜Ÿåˆ—
    this.queue = new PQueue({
      concurrency: 5, // åŒæ—¶å¤„ç† 5 ä¸ªä»»åŠ¡
      timeout: 1000 * 60 * 30, // å•ä¸ªä»»åŠ¡è¶…æ—¶ 30 åˆ†é’Ÿ
      throwOnTimeout: true
    })

    // é”™è¯¯å¤„ç†
    this.queue.on('error', (error) => {
      console.error('Queue error:', error)
    })

    // ä»»åŠ¡å®Œæˆæ—¥å¿—
    this.queue.on('completed', (result) => {
      console.log('Task completed:', result)
    })

    // ä»»åŠ¡å¤±è´¥æ—¥å¿—
    this.queue.on('failed', (error, task) => {
      console.error('Task failed:', error, task)
    })
  }

  // å•ä¾‹æ¨¡å¼
  static getInstance(): TranslationQueue {
    if (!this.instance) {
      this.instance = new TranslationQueue()
    }
    return this.instance
  }

  // æ·»åŠ ç¿»è¯‘ä»»åŠ¡
  async addTranslationTask(
    handler: () => Promise<void>
  ): Promise<void> {
    return this.queue.add(handler)
  }

  // è·å–é˜Ÿåˆ—çŠ¶æ€
  getStatus() {
    return {
      size: this.queue.size, // ç­‰å¾…ä¸­çš„ä»»åŠ¡æ•°
      pending: this.queue.pending, // æ­£åœ¨å¤„ç†çš„ä»»åŠ¡æ•°
      isPaused: this.queue.isPaused
    }
  }

  // æš‚åœé˜Ÿåˆ—
  pause(): void {
    this.queue.pause()
  }

  // æ¢å¤é˜Ÿåˆ—
  start(): void {
    this.queue.start()
  }

  // æ¸…ç©ºé˜Ÿåˆ—
  clear(): void {
    this.queue.clear()
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
// api/webhooks/github/route.ts
import { TranslationQueue } from '@/lib/queue/translation-queue'

export async function POST(request: Request) {
  const queue = TranslationQueue.getInstance()

  // æ·»åŠ ç¿»è¯‘ä»»åŠ¡åˆ°é˜Ÿåˆ—
  await queue.addTranslationTask(async () => {
    await processTranslation(repositoryId, files)
  })

  return Response.json({ success: true })
}
```

### 4.2 è®¤è¯æ¨¡å— (lib/auth/)

#### 4.2.1 GitHub OAuthï¼ˆä»…ç”¨äºèº«ä»½è¯†åˆ«ï¼‰

```typescript
// lib/auth/github-oauth.ts
export class GitHubOAuth {
  // è·å– OAuth æˆæƒ URL
  getAuthorizationUrl(state: string): string {
    return `https://github.com/login/oauth/authorize?client_id=${
      process.env.GITHUB_CLIENT_ID
    }&redirect_uri=${
      process.env.GITHUB_OAUTH_CALLBACK_URL
    }&scope=read:user,user:email&state=${state}`
  }

  // ç”¨ code æ¢å– access token
  async exchangeCodeForToken(code: string): Promise<OAuthToken> {
    const response = await fetch('https://github.com/login/oauth/access_token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        client_id: process.env.GITHUB_CLIENT_ID,
        client_secret: process.env.GITHUB_CLIENT_SECRET,
        code
      })
    })

    const data = await response.json()
    return data
  }

  // è·å–ç”¨æˆ·ä¿¡æ¯
  async getUserInfo(token: string): Promise<GitHubUser> {
    const octokit = new Octokit({ auth: token })
    const { data } = await octokit.rest.users.getAuthenticated()
    return {
      id: data.id.toString(),
      login: data.login,
      email: data.email,
      avatar_url: data.avatar_url
    }
  }
}
```

#### 4.2.2 GitHub App ç®¡ç†

```typescript
// lib/github/app.ts
export class GitHubAppManager {
  // ç”Ÿæˆ GitHub App å®‰è£… URL
  getInstallationUrl(state: string): string {
    return `https://github.com/apps/${
      process.env.GITHUB_APP_NAME
    }/installations/new?state=${state}`
  }

  // å¤„ç† GitHub App å®‰è£…å›è°ƒ
  async handleInstallation(installationId: number, account: GitHubAccount): Promise<void> {
    // è·å– installation access token
    const token = await this.getInstallationToken(installationId)

    // è·å–å®‰è£…çš„ä»“åº“åˆ—è¡¨
    const repositories = await this.getInstallationRepositories(installationId)

    // ä¿å­˜åˆ°æ•°æ®åº“
    await prisma.gitHubAppInstallation.upsert({
      where: { installationId },
      create: {
        installationId,
        userId: account.user_id,
        githubAccountId: account.id,
        accountLogin: account.login,
        accountType: account.type,
        permissions: account.permissions,
        repositorySelection: account.repository_selection,
        accessToken: token.token,
        expiresAt: new Date(token.expires_at * 1000)
      },
      update: {
        accessToken: token.token,
        expiresAt: new Date(token.expires_at * 1000)
      }
    })
  }

  // è·å– installation access tokenï¼ˆ1å°æ—¶æœ‰æ•ˆï¼‰
  async getInstallationToken(installationId: number): Promise<InstallationAccessToken> {
    const response = await fetch(
      `https://api.github.com/app/installations/${installationId}/access_tokens`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${await this.getAppJWT()}`,
          'Accept': 'application/vnd.github+json'
        }
      }
    )

    return response.json()
  }

  // ç”Ÿæˆ GitHub App JWTï¼ˆç”¨äºè®¤è¯ï¼‰
  private async getAppJWT(): Promise<string> {
    const payload = {
      iat: Math.floor(Date.now() / 1000),
      exp: Math.floor(Date.now() / 1000) + 60,
      iss: process.env.GITHUB_APP_ID
    }

    return jwt.sign(payload, this.getPrivateKey(), { algorithm: 'RS256' })
  }
}
```

### 4.3 GitHub API æ¨¡å— (lib/github/)

```typescript
// lib/github/client.ts
export class GitHubClient {
  private octokit: Octokit

  constructor(installationId: number) {
    // ä½¿ç”¨ Installation Access Token
    this.octokit = new Octokit({
      auth: async () => {
        const token = await getInstallationToken(installationId)
        return token.token
      }
    })
  }

  // ä»“åº“ç®¡ç†
  async listRepositories(installationId: number): Promise<Repository[]> {
    const response = await this.octokit.rest.apps.listReposAccessibleToInstallation({
      installation_id: installationId
    })
    return response.data.repositories
  }

  // Webhook ç®¡ç†
  async createWebhook(repoId: number, config: WebhookConfig): Promise<Webhook> {
    const { data } = await this.octokit.rest.repos.createWebhook({
      repository_id: repoId,
      name: 'web',
      active: true,
      events: ['push'],
      config: {
        url: config.url,
        content_type: 'json',
        secret: config.secret,
        insecure_ssl: false
      }
    })
    return data
  }

  // Git æ“ä½œ
  async getCommitDiff(repoFullName: string, from: string, to: string): Promise<GitDiff[]> {
    const [owner, repo] = repoFullName.split('/')

    const { data } = await this.octokit.rest.repos.compareCommits({
      owner,
      repo,
      base: from,
      head: to
    })

    return data.files || []
  }

  async createBranch(repoFullName: string, branch: string, from: string): Promise<void> {
    const [owner, repo] = repoFullName.split('/')

    // è·å– base commit SHA
    const { data: ref } = await this.octokit.rest.git.getRef({
      owner,
      repo,
      ref: `heads/${from}`
    })

    // åˆ›å»ºæ–°åˆ†æ”¯
    await this.octokit.rest.git.createRef({
      owner,
      repo,
      ref: `refs/heads/${branch}`,
      sha: ref.object.sha
    })
  }

  async createFile(
    repoFullName: string,
    path: string,
    content: string,
    branch: string
  ): Promise<void> {
    const [owner, repo] = repoFullName.split('/')
    const contentBase64 = Buffer.from(content).toString('base64')

    await this.octokit.rest.repos.createOrUpdateFileContents({
      owner,
      repo,
      path,
      branch,
      content: contentBase64,
      message: `docs: update ${path}`
    })
  }

  async createPR(repoFullName: string, options: PROptions): Promise<PullRequest> {
    const [owner, repo] = repoFullName.split('/')

    const { data } = await this.octokit.rest.pulls.create({
      owner,
      repo,
      title: options.title,
      body: options.body,
      head: options.head,
      base: options.base,
      labels: options.labels || ['translation', 'automated']
    })

    return data
  }

  // å†…å®¹è·å–
  async getFileContent(repoFullName: string, path: string, ref: string): Promise<string> {
    const [owner, repo] = repoFullName.split('/')

    const { data } = await this.octokit.rest.repos.getContent({
      owner,
      repo,
      path,
      ref
    })

    if ('content' in data) {
      return Buffer.from(data.content, 'base64').toString('utf-8')
    }

    throw new Error('File not found')
  }
}
```

### 4.4 ç¿»è¯‘å¼•æ“æ¨¡å— (lib/translation/)

#### 4.4.1 OpenRouter å¼•æ“ï¼ˆæ¨èï¼‰

```typescript
// lib/translation/openrouter.ts
import OpenAI from 'openai'

export class OpenRouterEngine {
  private client: OpenAI
  private config: OpenRouterConfig

  constructor(apiKey: string, config: OpenRouterConfig) {
    this.client = new OpenAI({
      apiKey: apiKey,
      baseURL: 'https://openrouter.ai/api/v1',
      defaultHeaders: {
        'HTTP-Referer': process.env.APP_URL,
        'X-Title': 'GitHub Global'
      }
    })
    this.config = config
  }

  async translate(
    text: string,
    from: string,
    to: string,
    context?: TranslationContext
  ): Promise<TranslationResult> {
    const systemPrompt = this.buildSystemPrompt(from, to, context)

    try {
      const response = await this.client.chat.completions.create({
        model: this.config.model,
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: text }
        ],
        temperature: this.config.temperature || 0.3,
        max_tokens: this.config.maxTokens || 4000
      })

      const translatedText = response.choices[0].message.content || ''

      return {
        text: translatedText,
        model: response.model,
        usage: {
          promptTokens: response.usage?.prompt_tokens || 0,
          completionTokens: response.usage?.completion_tokens || 0,
          totalTokens: response.usage?.total_tokens || 0
        }
      }
    } catch (error) {
      // å¦‚æœé…ç½®äº† fallbackï¼Œè‡ªåŠ¨é™çº§
      if (this.config.fallbackModels && this.config.fallbackModels.length > 0) {
        return this.translateWithFallback(text, from, to, context, 0)
      }
      throw error
    }
  }

  private async translateWithFallback(
    text: string,
    from: string,
    to: string,
    context: TranslationContext | undefined,
    fallbackIndex: number
  ): Promise<TranslationResult> {
    if (fallbackIndex >= this.config.fallbackModels!.length) {
      throw new Error('All translation models failed')
    }

    const fallbackModel = this.config.fallbackModels![fallbackIndex]

    try {
      const response = await this.client.chat.completions.create({
        model: fallbackModel,
        messages: [
          { role: 'system', content: this.buildSystemPrompt(from, to, context) },
          { role: 'user', content: text }
        ],
        temperature: this.config.temperature || 0.3,
        max_tokens: this.config.maxTokens || 4000
      })

      const translatedText = response.choices[0].message.content || ''

      return {
        text: translatedText,
        model: response.model,
        usage: {
          promptTokens: response.usage?.prompt_tokens || 0,
          completionTokens: response.usage?.completion_tokens || 0,
          totalTokens: response.usage?.total_tokens || 0
        }
      }
    } catch (error) {
      // å°è¯•ä¸‹ä¸€ä¸ª fallback
      return this.translateWithFallback(text, from, to, context, fallbackIndex + 1)
    }
  }

  private buildSystemPrompt(from: string, to: string, context?: TranslationContext): string {
    let prompt = `You are a professional translator. Translate the following text from ${from} to ${to}.

Important rules:
1. Preserve Markdown structure (code blocks, links, images)
2. Do not translate code content inside code blocks
3. Do not translate URLs
4. Preserve image alt text but translate it
5. Maintain the original formatting
6. For technical terms, keep the English term and add translation in parentheses if needed`

    if (context) {
      prompt += `\n\nContext: This is from a ${context.fileName} in the ${context.projectName} project.`
      if (context.projectDescription) {
        prompt += `\nProject description: ${context.projectDescription}`
      }
    }

    return prompt
  }
}

// é…ç½®ç±»å‹
interface OpenRouterConfig {
  model: string // 'openai/gpt-4-turbo'
  fallbackModels?: string[] // ['openai/gpt-4o', 'anthropic/claude-3.5-sonnet']
  temperature?: number
  maxTokens?: number
}

interface TranslationContext {
  fileName: string
  projectName: string
  projectDescription?: string
}

interface TranslationResult {
  text: string
  model: string
  usage: {
    promptTokens: number
    completionTokens: number
    totalTokens: number
  }
}
```

#### 4.4.2 Markdown å¤„ç†å™¨

```typescript
// lib/translation/markdown.ts
import { unified } from 'unified'
import remarkParse from 'remark-parse'
import remarkStringify from 'remark-stringify'

export class MarkdownProcessor {
  private processor = unified()
    .use(remarkParse)
    .use(remarkStringify, {
      bullet: '-',
      fence: '`',
      fences: true,
      incrementListMarker: false
    })

  // ä¿ç•™ç‰¹å®šç»“æ„çš„ç¿»è¯‘
  async translateWithStructurePreservation(
    markdown: string,
    translator: (text: string) => Promise<string>
  ): Promise<string> {
    // åˆ†ç¦»ä»£ç å—å’Œéä»£ç å—
    const codeBlocks: RegExpMatchArray[] = []
    let processedMarkdown = markdown.replace(/```[\s\S]*?```/g, (match) => {
      codeBlocks.push([match])
      return `__CODE_BLOCK_${codeBlocks.length - 1}__`
    })

    // åˆ†ç¦» inline code
    processedMarkdown = processedMarkdown.replace(/`[^`]+`/g, (match) => {
      codeBlocks.push([match])
      return `__INLINE_CODE_${codeBlocks.length - 1}__`
    })

    // åˆ†ç¦»é“¾æ¥
    processedMarkdown = processedMarkdown.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_, text, url) => {
      codeBlocks.push([text, url])
      return `__LINK_${codeBlocks.length - 1}__`
    })

    // ç¿»è¯‘å‰©ä½™æ–‡æœ¬
    const translatedText = await translator(processedMarkdown)

    // æ¢å¤ä»£ç å—å’Œé“¾æ¥
    let result = translatedText
    for (const [i, block] of codeBlocks.entries()) {
      result = result.replace(
        new RegExp(`__(CODE_BLOCK|INLINE_CODE|LINK)_${i}__`, 'g'),
        () => block.join('](')
      )
    }

    return result
  }
}
```

### 4.5 Webhook æ¨¡å— (lib/webhook/)

```typescript
// lib/webhook/handler.ts
import crypto from 'crypto'
import { TranslationQueue } from '../queue/translation-queue'

const queue = TranslationQueue.getInstance()

export class WebhookHandler {
  // éªŒè¯ webhook ç­¾å
  verifySignature(
    payload: string,
    signature: string,
    secret: string
  ): boolean {
    const signatureBuffer = Buffer.from(signature, 'utf8')
    const hmac = crypto.createHmac('sha256', secret)
    const digest = hmac.update(payload).digest('buffer')
    const digestBuffer = Buffer.from(`sha256=${digest.toString()}`, 'utf8')

    // ä½¿ç”¨ timingSafeEqual é˜²æ­¢æ—¶åºæ”»å‡»
    return crypto.timingSafeEqual(digestBuffer, signatureBuffer)
  }

  // å¤„ç† push äº‹ä»¶
  async handlePush(event: PushEvent): Promise<void> {
    const repository = await this.getRepositoryByGitHubId(event.repository.id)

    if (!repository || !repository.config) {
      console.log('Repository not configured for translation')
      return
    }

    // æ£€æŸ¥è§¦å‘æ¨¡å¼
    if (repository.config.triggerMode !== 'webhook') {
      return
    }

    // æå–å˜æ›´æ–‡ä»¶
    const changedFiles = this.extractChangedFiles(event)

    // è¿‡æ»¤éœ€è¦ç¿»è¯‘çš„æ–‡ä»¶
    const filesToTranslate = this.filterTranslatableFiles(
      changedFiles,
      repository.config
    )

    if (filesToTranslate.length === 0) {
      console.log('No translatable files changed')
      return
    }

    // åˆ›å»ºç¿»è¯‘ä»»åŠ¡
    const task = await prisma.translationTask.create({
      data: {
        repositoryId: repository.id,
        triggerType: 'webhook',
        triggerCommitSha: event.after,
        status: 'pending',
        totalFiles: filesToTranslate.length
      }
    })

    // æ·»åŠ åˆ°æœ¬åœ°é˜Ÿåˆ—
    await queue.addTranslationTask(async () => {
      await this.processTranslation(task.id, repository.id, filesToTranslate)
    })

    console.log(`Translation task ${task.id} added to queue`)
  }

  // æå–å˜æ›´æ–‡ä»¶
  private extractChangedFiles(event: PushEvent): ChangedFile[] {
    const files: ChangedFile[] = []

    for (const commit of event.commits) {
      if (commit.added) {
        files.push(...commit.added.map(path => ({ path, status: 'added' })))
      }
      if (commit.modified) {
        files.push(...commit.modified.map(path => ({ path, status: 'modified' })))
      }
    }

    return files
  }

  // è¿‡æ»¤éœ€è¦ç¿»è¯‘çš„æ–‡ä»¶
  private filterTranslatableFiles(
    files: ChangedFile[],
    config: TranslationConfig
  ): ChangedFile[] {
    const patterns = config.filePatterns as string[]
    const excludePatterns = (config.excludePatterns || []) as string[]

    return files.filter(file => {
      // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
      if (!file.path.match(/\.(md|markdown|txt)$/i)) {
        return false
      }

      // æ£€æŸ¥æ˜¯å¦åŒ¹é…åŒ…å«æ¨¡å¼
      const isIncluded = patterns.some(pattern => this.matchPattern(file.path, pattern))

      // æ£€æŸ¥æ˜¯å¦åŒ¹é…æ’é™¤æ¨¡å¼
      const isExcluded = excludePatterns.some(pattern =>
        this.matchPattern(file.path, pattern)
      )

      return isIncluded && !isExcluded
    })
  }

  // ç®€å•çš„ glob æ¨¡å¼åŒ¹é…
  private matchPattern(path: string, pattern: string): boolean {
    // è½¬æ¢ glob é£æ ¼æ¨¡å¼ä¸ºæ­£åˆ™è¡¨è¾¾å¼
    const regexPattern = pattern
      .replace(/\*/g, '.*')
      .replace(/\?/g, '.')

    const regex = new RegExp(regexPattern)
    return regex.test(path)
  }

  // å¤„ç†ç¿»è¯‘ä»»åŠ¡
  private async processTranslation(
    taskId: string,
    repositoryId: string,
    files: ChangedFile[]
  ): Promise<void> {
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    await prisma.translationTask.update({
      where: { id: taskId },
      data: {
        status: 'processing',
        startedAt: new Date()
      }
    })

    try {
      // è·å–é…ç½®
      const config = await this.getRepositoryConfig(repositoryId)
      const engine = await this.createTranslationEngine(repositoryId)
      const githubClient = new GitHubClient(config.repository.installation.installationId)

      let processedFiles = 0
      let failedFiles = 0
      let totalTokens = 0

      // ç¿»è¯‘æ–‡ä»¶
      const results = []
      for (const file of files) {
        try {
          // è¯»å–æ–‡ä»¶å†…å®¹
          const content = await githubClient.getFileContent(
            config.repository.fullName,
            file.path,
            'main'
          )

          // ç¿»è¯‘
          const processor = new MarkdownProcessor()
          const translatedContent = await processor.translateWithStructurePreservation(
            content,
            async (text) => {
              const result = await engine.translate(
                text,
                config.baseLanguage,
                config.targetLanguages[0], // ç®€åŒ–ï¼šåªå–ç¬¬ä¸€ä¸ªç›®æ ‡è¯­è¨€
                {
                  fileName: file.path,
                  projectName: config.repository.name,
                  projectDescription: config.repository.description
                }
              )
              totalTokens += result.usage.totalTokens
              return result.text
            }
          )

          // åˆ›å»ºåˆ†æ”¯å’Œæäº¤
          const targetLanguage = config.targetLanguages[0]
          const branchName = config.targetBranchTemplate.replace('{lang}', targetLanguage)
          const targetPath = file.path.replace(/\.md$/, `/${targetLanguage}.md`)

          await githubClient.createBranch(config.repository.fullName, branchName, 'main')
          await githubClient.createFile(config.repository.fullName, targetPath, translatedContent, branchName)

          results.push({
            success: true,
            path: file.path,
            targetPath
          })

          processedFiles++
        } catch (error) {
          console.error(`Failed to translate ${file.path}:`, error)
          failedFiles++
          results.push({
            success: false,
            path: file.path,
            error: error.message
          })
        }
      }

      // åˆ›å»º PR
      const targetLanguage = config.targetLanguages[0]
      const branchName = config.targetBranchTemplate.replace('{lang}', targetLanguage)

      const pr = await githubClient.createPR(config.repository.fullName, {
        title: `docs: translate to ${targetLanguage}`,
        body: this.generatePRDescription(results, totalTokens),
        head: branchName,
        base: 'main',
        labels: ['translation', 'automated', 'i18n']
      })

      // æ›´æ–°ä»»åŠ¡çŠ¶æ€
      await prisma.translationTask.update({
        where: { id: taskId },
        data: {
          status: 'completed',
          processedFiles,
          failedFiles,
          totalTokens,
          completedAt: new Date()
        }
      })

      console.log(`Translation task ${taskId} completed. PR #${pr.number} created.`)
    } catch (error) {
      // æ›´æ–°ä»»åŠ¡ä¸ºå¤±è´¥çŠ¶æ€
      await prisma.translationTask.update({
        where: { id: taskId },
        data: {
          status: 'failed',
          errorMessage: error.message,
          completedAt: new Date()
        }
      })

      throw error
    }
  }

  // ç”Ÿæˆ PR æè¿°
  private generatePRDescription(results: any[], totalTokens: number): string {
    const successCount = results.filter(r => r.success).length
    const failCount = results.filter(r => !r.success).length

    return `## Translation Summary

This PR automatically translates documentation.

**Files translated:** ${successCount}
**Failed:** ${failCount}
**Total tokens used:** ${totalTokens}

---

### Translated Files

${results.filter(r => r.success).map(r => `- âœ… \`${r.path}\` â†’ \`${r.targetPath}\``).join('\n')}

${failCount > 0 ? `
### Failed Files

${results.filter(r => !r.success).map(r => `- âŒ \`${r.path}\`: ${r.error}`).join('\n')}
` : ''}

---

ğŸ¤– Generated by [GitHub Global](https://github-global.com)`
  }

  // è·å–ä»“åº“é…ç½®
  private async getRepositoryConfig(repositoryId: string) {
    const config = await prisma.translationConfig.findUnique({
      where: { repositoryId },
      include: {
        repository: {
          include: {
            installation: true
          }
        }
      }
    })

    if (!config) {
      throw new Error('Translation config not found')
    }

    return config
  }

  // åˆ›å»ºç¿»è¯‘å¼•æ“
  private async createTranslationEngine(repositoryId: string) {
    const engineConfig = await prisma.translationEngine.findFirst({
      where: {
        repositoryId,
        isActive: true
      }
    })

    if (!engineConfig) {
      throw new Error('No active translation engine found')
    }

    // è§£å¯† API Key
    const apiKey = await decryptAPIKey(engineConfig.encryptedApiKey)

    // æ ¹æ®å¼•æ“ç±»å‹åˆ›å»ºå®ä¾‹
    if (engineConfig.engineType === 'openrouter') {
      return new OpenRouterEngine(apiKey, engineConfig.config)
    }

    throw new Error(`Unsupported engine type: ${engineConfig.engineType}`)
  }

  // æ ¹æ® GitHub ID è·å–ä»“åº“
  private async getRepositoryByGitHubId(githubRepoId: number) {
    return prisma.repository.findUnique({
      where: { githubRepoId },
      include: {
        config: true
      }
    })
  }
}
```

---

## 5. ä¸šåŠ¡æµç¨‹è®¾è®¡

### 5.1 ç”¨æˆ·è®¤è¯å’Œå®‰è£…æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant OAuth as GitHub OAuth
    participant App as GitHub App
    participant DB as æ•°æ®åº“

    User->>Frontend: è®¿é—®åº”ç”¨
    Frontend->>OAuth: GitHub OAuth ç™»å½•
    OAuth-->>Frontend: è¿”å›ç”¨æˆ·ä¿¡æ¯
    Frontend->>DB: åˆ›å»º/æ›´æ–°ç”¨æˆ·è®°å½•
    Frontend->>User: æ˜¾ç¤ºå®‰è£…å¼•å¯¼

    User->>App: ç‚¹å‡»å®‰è£… GitHub App
    App-->>Frontend: å®‰è£…å›è°ƒï¼ˆinstallation_idï¼‰
    Frontend->>App: è·å– installation access token
    App-->>Frontend: è¿”å› token å’Œä»“åº“åˆ—è¡¨
    Frontend->>DB: ä¿å­˜å®‰è£…ä¿¡æ¯å’Œä»“åº“
    Frontend-->>User: æ˜¾ç¤ºå·²è¿æ¥ä»“åº“
```

### 5.2 ç¿»è¯‘æ‰§è¡Œæµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

```mermaid
sequenceDiagram
    participant Webhook as GitHub Webhook
    participant Handler as Webhook Handler
    participant Queue as æœ¬åœ°é˜Ÿåˆ— (p-queue)
    participant Processer as ç¿»è¯‘å¤„ç†å™¨
    participant OpenRouter as OpenRouter API
    participant GitHub as GitHub API

    Webhook->>Handler: Push äº‹ä»¶
    Handler->>Handler: éªŒè¯ç­¾å
    Handler->>Handler: æå–å˜æ›´æ–‡ä»¶
    Handler->>Queue: æ·»åŠ ç¿»è¯‘ä»»åŠ¡
    Queue->>Processer: åˆ†é…ä»»åŠ¡ï¼ˆå¹¶å‘æ§åˆ¶ï¼‰

    Processer->>GitHub: è·å–æ–‡ä»¶å†…å®¹
    GitHub-->>Processer: è¿”å›æ–‡ä»¶å†…å®¹

    loop æ¯ä¸ªæ–‡ä»¶
        Processer->>OpenRouter: è°ƒç”¨ç¿»è¯‘ API
        OpenRouter-->>Processer: è¿”å›ç¿»è¯‘ç»“æœ
    end

    Processer->>GitHub: åˆ›å»ºåˆ†æ”¯
    Processer->>GitHub: æäº¤ç¿»è¯‘æ–‡ä»¶
    Processer->>GitHub: åˆ›å»º PR
```

**ç®€åŒ–è¯´æ˜**ï¼š
- âŒ ç§»é™¤äº†ç‹¬ç«‹çš„ Worker è¿›ç¨‹
- âŒ ç§»é™¤äº†å®æ—¶é€šçŸ¥åŠŸèƒ½ï¼ˆSocket.IOï¼‰
- âœ… ä½¿ç”¨æœ¬åœ°é˜Ÿåˆ—å¤„ç†ä»»åŠ¡
- âœ… ç¿»è¯‘å®Œæˆåæ•°æ®åº“è®°å½•ç»“æœ
- âœ… ç”¨æˆ·é€šè¿‡æ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€

---

## 6. API è®¾è®¡

### 6.1 è®¤è¯ API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | è®¤è¯ |
|------|------|------|------|
| `/api/auth/signin` | GET | è·å–ç™»å½• URL | - |
| `/api/auth/callback` | GET | OAuth å›è°ƒ | - |
| `/api/auth/signout` | POST | ç™»å‡º | Session |
| `/api/app/install` | GET | è·å– GitHub App å®‰è£… URL | Session |
| `/api/app/callback` | POST | GitHub App å®‰è£…å›è°ƒ | Session |

### 6.2 ä»“åº“ç®¡ç† API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | è®¤è¯ |
|------|------|------|------|
| `/api/repositories` | GET | è·å–ä»“åº“åˆ—è¡¨ | Session |
| `/api/repositories/sync` | POST | åŒæ­¥ GitHub ä»“åº“ | Session |
| `/api/repositories/:id/config` | GET | è·å–ç¿»è¯‘é…ç½® | Session |
| `/api/repositories/:id/config` | PUT | æ›´æ–°ç¿»è¯‘é…ç½® | Session |
| `/api/repositories/:id` | DELETE | æ–­å¼€ä»“åº“ | Session |

### 6.3 ç¿»è¯‘ä»»åŠ¡ API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | è®¤è¯ |
|------|------|------|------|
| `/api/repositories/:id/translations` | POST | è§¦å‘ç¿»è¯‘ä»»åŠ¡ | Session |
| `/api/repositories/:id/translations` | GET | è·å–ç¿»è¯‘ä»»åŠ¡åˆ—è¡¨ | Session |
| `/api/repositories/:id/translations/:taskId` | GET | è·å–ä»»åŠ¡è¯¦æƒ… | Session |
| `/api/repositories/:id/translations/:taskId/files` | GET | è·å–æ–‡ä»¶åˆ—è¡¨ | Session |

### 6.4 Webhook API

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | è®¤è¯ |
|------|------|------|------|
| `/api/webhooks/github` | POST | æ¥æ”¶ GitHub Webhook | ç­¾åéªŒè¯ |

---

## 7. å®‰å…¨è®¾è®¡

### 7.1 GitHub App å®‰å…¨

**JWT Token ç”Ÿæˆ**ï¼š
```typescript
// lib/github/jwt.ts
import jwt from 'jsonwebtoken'

export function generateAppJWT(): string {
  const payload = {
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + 60, // 1åˆ†é’Ÿè¿‡æœŸ
    iss: process.env.GITHUB_APP_ID
  }

  const privateKey = getPrivateKey()

  return jwt.sign(payload, privateKey, { algorithm: 'RS256' })
}

function getPrivateKey(): string {
  // ä»ç¯å¢ƒå˜é‡è¯»å–ç§é’¥
  return process.env.GITHUB_APP_PRIVATE_KEY!.replace(/\\n/g, '\n')
}
```

### 7.2 API å¯†é’¥åŠ å¯†

```typescript
// lib/crypto/encryption.ts
import crypto from 'crypto'

const ALGORITHM = 'aes-256-gcm'
const KEY_LENGTH = 32
const IV_LENGTH = 16
const AUTH_TAG_LENGTH = 16

export class EncryptionService {
  private key: Buffer

  constructor() {
    // ä»ç¯å¢ƒå˜é‡è·å–å¯†é’¥ï¼ˆ64 å­—èŠ‚åå…­è¿›åˆ¶ï¼‰
    this.key = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex')
  }

  encrypt(plaintext: string): string {
    const iv = crypto.randomBytes(IV_LENGTH)
    const cipher = crypto.createCipheriv(ALGORITHM, this.key, iv)

    let encrypted = cipher.update(plaintext, 'utf8', 'hex')
    encrypted += cipher.final('hex')

    const authTag = cipher.getAuthTag()

    return iv.toString('hex') + authTag.toString('hex') + encrypted
  }

  decrypt(ciphertext: string): string {
    const iv = Buffer.from(ciphertext.slice(0, IV_LENGTH * 2), 'hex')
    const authTag = Buffer.from(
      ciphertext.slice(IV_LENGTH * 2, (IV_LENGTH + AUTH_TAG_LENGTH) * 2),
      'hex'
    )
    const encrypted = ciphertext.slice((IV_LENGTH + AUTH_TAG_LENGTH) * 2)

    const decipher = crypto.createDecipheriv(ALGORITHM, this.key, iv)
    decipher.setAuthTag(authTag)

    let decrypted = decipher.update(encrypted, 'hex', 'utf8')
    decrypted += decipher.final('utf8')

    return decrypted
  }
}
```

### 7.3 Webhook ç­¾åéªŒè¯

```typescript
// lib/webhook/verification.ts
import crypto from 'crypto'

export function verifyWebhookSignature(
  payload: string,
  signature: string,
  secret: string
): boolean {
  const signatureBuffer = Buffer.from(signature, 'utf8')
  const hmac = crypto.createHmac('sha256', secret)
  const digest = hmac.update(payload).digest('buffer')
  const digestBuffer = Buffer.from(`sha256=${digest.toString()}`, 'utf8')

  // ä½¿ç”¨ timingSafeEqual é˜²æ­¢æ—¶åºæ”»å‡»
  return crypto.timingSafeEqual(digestBuffer, signatureBuffer)
}
```

---

## 8. æŠ€æœ¯é£é™©ä¸åº”å¯¹

### 8.1 å·²è¯†åˆ«é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹ç­–ç•¥ |
|------|------|------|----------|
| **OpenRouter API ä¸ç¨³å®š** | é«˜ | ä¸­ | - å†…ç½® fallback æœºåˆ¶<br>- å¤šæ¨¡å‹è‡ªåŠ¨é™çº§<br>- é”™è¯¯é‡è¯• |
| **GitHub API é™æµ** | ä¸­ | é«˜ | - GitHub App é™æµæ›´é«˜<br>- è¯·æ±‚é˜Ÿåˆ—<br>- æŒ‡æ•°é€€é¿ |
| **æ•°æ®åº“æ€§èƒ½ç“¶é¢ˆ** | é«˜ | ä½ | - ç´¢å¼•ä¼˜åŒ–<br>- è¿æ¥æ±  |
| **Webhook ä¸¢å¤±** | ä¸­ | ä½ | - å¹‚ç­‰è®¾è®¡<br>- æ‰‹åŠ¨é‡è¯• |
| **Token æ³„éœ²** | é«˜ | ä½ | - åŠ å¯†å­˜å‚¨<br>- GitHub App çŸ­æœŸ token |
| **é˜Ÿåˆ—ä»»åŠ¡ä¸¢å¤±** | ä¸­ | ä¸­ | - æ•°æ®åº“è®°å½•ä»»åŠ¡çŠ¶æ€<br>- å¤±è´¥ä»»åŠ¡å¯é‡è¯• |

**æ–°å¢é£é™©ï¼ˆæœ¬åœ°é˜Ÿåˆ—ï¼‰**ï¼š

| é£é™© | å½±å“ | åº”å¯¹ç­–ç•¥ |
|------|------|----------|
| **æœåŠ¡é‡å¯ä»»åŠ¡ä¸¢å¤±** | ä¸­ | - æ•°æ®åº“è®°å½•ä»»åŠ¡çŠ¶æ€<br>- æä¾›"é‡æ–°ç¿»è¯‘"åŠŸèƒ½ |
| **å¹¶å‘æ§åˆ¶ä¸ç²¾ç¡®** | ä½ | - p-queue å†…ç½®å¹¶å‘æ§åˆ¶<br>- å¯è°ƒæ•´å¹¶å‘æ•° |

### 8.2 OpenRouter é™çº§ç­–ç•¥

```typescript
// è‡ªåŠ¨é™çº§é…ç½®
const config = {
  model: 'openai/gpt-4-turbo',
  fallbackModels: [
    'openai/gpt-4o',
    'anthropic/claude-3.5-sonnet',
    'google/gemini-pro-1.5',
    'deepseek/deepseek-chat'
  ]
}

// å¦‚æœä¸»æ¨¡å‹å¤±è´¥ï¼Œè‡ªåŠ¨å°è¯• fallback æ¨¡å‹
```

---

## 9. å¼€å‘é‡Œç¨‹ç¢‘

### Phase 1: åŸºç¡€æ¡†æ¶ (Week 1-2)
- [ ] é¡¹ç›®åˆå§‹åŒ–ï¼ˆNext.js + Prismaï¼‰
- [ ] æ•°æ®åº“è®¾è®¡å’Œè¿ç§»
- [ ] GitHub OAuth é›†æˆ
- [ ] GitHub App é…ç½®
- [ ] åŸºç¡€ UI æ¡†æ¶

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (Week 3-4)
- [ ] GitHub App å®‰è£…æµç¨‹
- [ ] ä»“åº“åˆ—è¡¨å±•ç¤º
- [ ] ç¿»è¯‘é…ç½®ç•Œé¢
- [ ] OpenRouter é›†æˆ
- [ ] Markdown å¤„ç†

### Phase 3: ä»»åŠ¡ç³»ç»Ÿ (Week 5-6) âœ… ç®€åŒ–ç‰ˆ
- [ ] æœ¬åœ°é˜Ÿåˆ—é›†æˆï¼ˆp-queueï¼‰
- [ ] Webhook å¤„ç†
- [ ] æ–‡ä»¶å˜æ›´æ£€æµ‹
- [ ] PR åˆ›å»º
- [ ] é”™è¯¯å¤„ç†å’Œé‡è¯•

### Phase 4: å®Œå–„åŠŸèƒ½ (Week 7-8)
- [ ] å†å²è®°å½•
- [ ] ç¿»è¯‘è´¨é‡ä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–

### Phase 5: æµ‹è¯•å’Œä¼˜åŒ– (Week 9-10)
- [ ] é›†æˆæµ‹è¯•
- [ ] å®‰å…¨å®¡è®¡
- [ ] æ–‡æ¡£å®Œå–„

---

## 10. é™„å½•

### 10.1 ç¯å¢ƒå˜é‡é…ç½®ï¼ˆç®€åŒ–ç‰ˆï¼‰

```bash
# .env.example

# æ•°æ®åº“
DATABASE_URL="mysql://root:password@localhost:3306/github_global"

# åŠ å¯†å¯†é’¥ (ç”Ÿæˆ 64 å­—èŠ‚éšæœºå€¼)
ENCRYPTION_KEY="your-256-bit-hex-key-here"

# GitHub OAuthï¼ˆç”¨äºç™»å½•ï¼‰
GITHUB_CLIENT_ID="your_github_oauth_client_id"
GITHUB_CLIENT_SECRET="your_github_oauth_client_secret"
GITHUB_OAUTH_CALLBACK_URL="http://localhost:3000/api/auth/callback/github"

# GitHub Appï¼ˆç”¨äºä»“åº“æ“ä½œï¼‰
GITHUB_APP_ID="your_github_app_id"
GITHUB_APP_NAME="your_github_app_name"
GITHUB_APP_PRIVATE_KEY="-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----"
GITHUB_APP_WEBHOOK_SECRET="random_webhook_secret"

# NextAuth
NEXTAUTH_SECRET="your_nextauth_secret"
NEXTAUTH_URL="http://localhost:3000"

# åº”ç”¨é…ç½®
APP_URL="http://localhost:3000"
APP_NAME="GitHub Global"

# æ—¥å¿—
LOG_LEVEL="info"

# é˜Ÿåˆ—é…ç½®ï¼ˆæœ¬åœ°é˜Ÿåˆ—ï¼‰
QUEUE_CONCURRENCY=5
```

**å·²ç§»é™¤**ï¼š
- âŒ Redis ç›¸å…³é…ç½®
- âŒ Worker è¿›ç¨‹é…ç½®

### 10.2 GitHub App åˆ›å»ºæ­¥éª¤

1. **åˆ›å»º GitHub App**:
   - è®¿é—® https://github.com/settings/apps
   - ç‚¹å‡» "New GitHub App"
   - å¡«å†™åŸºæœ¬ä¿¡æ¯

2. **é…ç½®æƒé™**:
   ```
   Repository permissions:
   - Contents: Read & Write
   - Pull requests: Read & Write
   - Metadata: Read-only
   ```

3. **é…ç½® Webhook**:
   ```
   Webhook URL: http://localhost:3000/api/webhooks/github
   Content type: application/json
   Secret: (ç”Ÿæˆéšæœºå­—ç¬¦ä¸²)
   Events:
   - Push events
   ```

4. **ç”Ÿæˆç§é’¥**:
   - ç‚¹å‡» "Generate a private key"
   - ä¸‹è½½ .pem æ–‡ä»¶
   - å°†å†…å®¹æ·»åŠ åˆ°ç¯å¢ƒå˜é‡

### 10.3 OpenRouter API é…ç½®

1. **æ³¨å†Œ OpenRouter**:
   - è®¿é—® https://openrouter.ai/
   - åˆ›å»ºè´¦å·

2. **è·å– API Key**:
   - è¿›å…¥ Settings
   - ç”Ÿæˆ API Key

3. **é€‰æ‹©æ¨¡å‹**:
   - æŸ¥çœ‹å¯ç”¨æ¨¡å‹: https://openrouter.ai/models
   - é€‰æ‹©é€‚åˆçš„æ¨¡å‹ï¼ˆå»ºè®® `openai/gpt-4-turbo`ï¼‰

### 10.4 æœ¬åœ°å¼€å‘ç¯å¢ƒæ­å»ºï¼ˆç®€åŒ–ç‰ˆï¼‰

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/yourusername/github-global.git
cd github-global

# 2. å®‰è£…ä¾èµ–
npm install

# 3. è®¾ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥å®é™…çš„é…ç½®å€¼

# 4. å¯åŠ¨ MySQLï¼ˆDockerï¼‰
docker run -d \
  --name github-global-mysql \
  -e MYSQL_ROOT_PASSWORD=password \
  -e MYSQL_DATABASE=github_global \
  -p 3306:3306 \
  mysql:8.0

# 5. è¿è¡Œæ•°æ®åº“è¿ç§»
npx prisma migrate dev

# 6. ç”Ÿæˆ Prisma Client
npx prisma generate

# 7. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

**å·²ç§»é™¤**ï¼š
- âŒ Redis å®¹å™¨
- âŒ Worker è¿›ç¨‹

### 10.5 ä¾èµ–åŒ…ï¼ˆç®€åŒ–ç‰ˆï¼‰

```json
{
  "dependencies": {
    "next": "^15.0.0",
    "react": "^19.0.0",
    "typescript": "^5.0.0",
    "@prisma/client": "^5.0.0",
    "p-queue": "^8.0.0",
    "octokit": "^4.0.0",
    "@octokit/webhooks": "^13.0.0",
    "next-auth": "^5.0.0",
    "openai": "^4.0.0",
    "unified": "^11.0.0",
    "remark-parse": "^11.0.0",
    "remark-stringify": "^11.0.0",
    "jsonwebtoken": "^9.0.0",
    "crypto": "^1.0.0"
  },
  "devDependencies": {
    "prisma": "^5.0.0",
    "tailwindcss": "^3.0.0"
  }
}
```

### 10.6 å‚è€ƒèµ„æ–™

**æŠ€æœ¯æ–‡æ¡£**ï¼š
- GitHub App: https://docs.github.com/en/apps
- GitHub REST API: https://docs.github.com/en/rest
- Next.js: https://nextjs.org/docs
- Prisma: https://www.prisma.io/docs
- p-queue: https://github.com/sindresorhus/p-queue
- OpenRouter: https://openrouter.ai/docs

**æœ€ä½³å®è·µ**ï¼š
- GitHub App æœ€ä½³å®è·µ: https://docs.github.com/en/apps/best-practices
- Webhook å®‰å…¨: https://docs.github.com/en/webhooks
- Markdown è§£æ: https://github.com/unifiedjs/unified

### 10.7 åç»­æ‰©å±•åˆ° BullMQ

å½“éœ€è¦æ‰©å±•åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿ç§»ï¼š

```typescript
// 1. å®‰è£…ä¾èµ–
// npm install bullmq ioredis

// 2. åˆ›å»º BullMQ é˜Ÿåˆ—
import { Queue } from 'bullmq'

class ProductionQueue {
  private queue: Queue

  constructor() {
    this.queue = new Queue('translation', {
      connection: {
        host: process.env.REDIS_HOST,
        port: parseInt(process.env.REDIS_PORT || '6379')
      }
    })
  }

  async addTranslationTask(task: TranslationTask): Promise<void> {
    await this.queue.add('translate', task)
  }
}

// 3. åˆ›å»ºç‹¬ç«‹ Worker
// workers/translation.worker.ts
import { Worker } from 'bullmq'

const worker = new Worker('translation', async (job) => {
  await processTranslation(job.data)
}, {
  connection: {
    host: process.env.REDIS_HOST,
    port: parseInt(process.env.REDIS_PORT || '6379')
  }
})
```

**è¿ç§»ä¼˜åŠ¿**ï¼š
- âœ… ä»»åŠ¡æŒä¹…åŒ–
- âœ… åˆ†å¸ƒå¼å¤„ç†
- âœ… æ›´å¥½çš„ç›‘æ§
- âœ… æ›´é«˜çš„å¯ç”¨æ€§

**è¿ç§»ä¼˜åŠ¿**ï¼š
- âœ… ä»»åŠ¡æŒä¹…åŒ–
- âœ… åˆ†å¸ƒå¼å¤„ç†
- âœ… æ›´å¥½çš„ç›‘æ§
- âœ… æ›´é«˜çš„å¯ç”¨æ€§

---

### 10.8 æ‰©å±•é˜¶æ®µåŠŸèƒ½

ä»¥ä¸‹åŠŸèƒ½å°†åœ¨ **MVP å®Œæˆå** æ ¹æ®å®é™…éœ€æ±‚é€æ­¥æ·»åŠ ï¼š

#### 10.8.1 å®æ—¶é€šä¿¡åŠŸèƒ½

**è®¡åˆ’æŠ€æœ¯**: Socket.IO

**åŠŸèƒ½æè¿°**:
- å®æ—¶æ¨é€ç¿»è¯‘ä»»åŠ¡è¿›åº¦
- WebSocket é•¿è¿æ¥
- ä»»åŠ¡å®Œæˆå³æ—¶é€šçŸ¥
- é”™è¯¯å®æ—¶åé¦ˆ

**å®ç°ä¼˜å…ˆçº§**: P2ï¼ˆé«˜ä¼˜å…ˆçº§æ‰©å±•åŠŸèƒ½ï¼‰

**å®ç°æ–¹æ¡ˆ**:
```typescript
// æ‰©å±•é˜¶æ®µå®ç°
// lib/ws/server.ts
import { Server } from 'socket.io'

export class WSServer {
  private io: Server

  constructor() {
    this.io = new Server({
      cors: {
        origin: process.env.APP_URL,
        methods: ['GET', 'POST']
      }
    })

    this.io.on('connection', (socket) => {
      console.log('Client connected:', socket.id)

      // åŠ å…¥ä»“åº“æˆ¿é—´
      socket.on('join:repository', (repositoryId) => {
        socket.join(`repository:${repositoryId}`)
      })

      socket.on('disconnect', () => {
        console.log('Client disconnected:', socket.id)
      })
    })
  }

  // å‘é€ä»»åŠ¡è¿›åº¦æ›´æ–°
  sendTaskProgress(repositoryId: string, taskId: string, progress: number) {
    this.io.to(`repository:${repositoryId}`).emit('task:progress', {
      taskId,
      progress,
      timestamp: new Date()
    })
  }

  // å‘é€ä»»åŠ¡å®Œæˆé€šçŸ¥
  sendTaskCompleted(repositoryId: string, task: TranslationTask) {
    this.io.to(`repository:${repositoryId}`).emit('task:completed', {
      taskId: task.id,
      status: task.status,
      prNumber: task.prNumber
    })
  }

  // å‘é€é”™è¯¯é€šçŸ¥
  sendError(repositoryId: string, error: Error) {
    this.io.to(`repository:${repositoryId}`).emit('task:error', {
      message: error.message,
      timestamp: new Date()
    })
  }
}
```

**å‰ç«¯é›†æˆ**:
```typescript
// å®¢æˆ·ç«¯ç›‘å¬å®æ—¶æ›´æ–°
import { io } from 'socket.io-client'

const socket = io(process.env.NEXT_PUBLIC_APP_URL)

socket.on('task:progress', (data) => {
  console.log('Translation progress:', data.progress)
  // æ›´æ–°è¿›åº¦æ¡
})

socket.on('task:completed', (data) => {
  console.log('Translation completed:', data.taskId)
  // æ˜¾ç¤ºå®Œæˆé€šçŸ¥
})

socket.on('task:error', (data) => {
  console.error('Translation error:', data.message)
  // æ˜¾ç¤ºé”™è¯¯æç¤º
})
```

#### 10.8.2 å…¶ä»–æ‰©å±•åŠŸèƒ½

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | æŠ€æœ¯æ–¹æ¡ˆ |
|------|--------|----------|
| **åˆ†å¸ƒå¼ä»»åŠ¡é˜Ÿåˆ—** | P1 | è¿ç§»åˆ° BullMQ + Redis |
| **ç¿»è¯‘è´¨é‡è¯„åˆ†** | P2 | äººå·¥å®¡æ ¸ + è‡ªåŠ¨è¯„åˆ† |
| **ç¿»è¯‘è®°å¿†åº“** | P2 | é‡å¤å†…å®¹ç¼“å­˜ |
| **å¤šè¯­è¨€æ‰¹é‡ç¿»è¯‘** | P2 | å¹¶å‘ä¼˜åŒ– |
| **å®šæ—¶ä»»åŠ¡** | P3 | node-cron |
| **é‚®ä»¶é€šçŸ¥** | P3 | Nodemailer |
| **æˆæœ¬åˆ†æ** | P2 | Token ç»Ÿè®¡ + æˆæœ¬ä¼°ç®— |

---

**æ–‡æ¡£ç»“æŸ**

**ç‰ˆæœ¬è¯´æ˜**ï¼š
- v1.0: åˆå§‹ç‰ˆæœ¬ï¼ˆåŒ…å« BullMQ + Redis + Socket.IOï¼‰
- v1.1: ç®€åŒ–ç‰ˆæœ¬ï¼ˆç§»é™¤ Redisï¼Œä½¿ç”¨ p-queueï¼‰
- v1.2: æç®€ MVP ç‰ˆæœ¬ï¼ˆç§»é™¤ Socket.IOï¼‰âœ… **å½“å‰ç‰ˆæœ¬**

**æŠ€æœ¯æ ˆæ¼”è¿›**ï¼š
| ç‰ˆæœ¬ | ç§»é™¤ç»„ä»¶ | ç†ç”± |
|------|----------|------|
| v1.1 | Redis | MVP é˜¶æ®µä¸éœ€è¦åˆ†å¸ƒå¼é˜Ÿåˆ— |
| v1.2 | Socket.IO | MVP é˜¶æ®µä¸éœ€è¦å®æ—¶é€šä¿¡ |

**å½“å‰ MVP æŠ€æœ¯æ ˆ**ï¼š
- âœ… Next.js 15 + TypeScript
- âœ… Prisma + MySQL
- âœ… p-queueï¼ˆæœ¬åœ°é˜Ÿåˆ—ï¼‰
- âœ… GitHub App + OpenRouter
- âŒ Redisï¼ˆæ‰©å±•é˜¶æ®µï¼‰
- âŒ Socket.IOï¼ˆæ‰©å±•é˜¶æ®µï¼‰
